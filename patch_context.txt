package com.example.mysched;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.app.NotificationChannel;
import android.app.NotificationManager;
import android.app.PendingIntent;
import android.os.Build;
import androidx.core.app.NotificationCompat;
import androidx.core.content.ContextCompat;

public class AlarmReceiver extends BroadcastReceiver {
	@Override
	public void onReceive(Context context, Intent intent) {
		try {
			android.os.PowerManager powerManager =
				(android.os.PowerManager) context.getSystemService(Context.POWER_SERVICE);
			android.os.PowerManager.WakeLock wakeLock = powerManager.newWakeLock(
				android.os.PowerManager.FULL_WAKE_LOCK
					| android.os.PowerManager.ACQUIRE_CAUSES_WAKEUP
					| android.os.PowerManager.ON_AFTER_RELEASE,
				"AlarmReceiver:AlarmWakeLock");
			wakeLock.acquire(2 * 60 * 1000);
			android.util.Log.d("AlarmReceiver", "Wake lock acquired before launching alarm activity");
		} catch (Throwable t) {
			android.util.Log.e("AlarmReceiver", "Failed to acquire wake lock", t);
		}
		android.util.Log.d("AlarmReceiver", "onReceive called. Intent: " + intent);

		String title = intent.getStringExtra("title");
		String body = intent.getStringExtra("body");
		int requestCode = intent.getIntExtra("requestCode", 0);
		int classId = intent.getIntExtra("classId", -1);
		String occurrenceKey = intent.getStringExtra("occurrenceKey");
		if (occurrenceKey == null) {
			occurrenceKey = "";
		}
		String subject = intent.getStringExtra("subject");
		String room = intent.getStringExtra("room");
		String startTime = intent.getStringExtra("startTime");
		String endTime = intent.getStringExtra("endTime");
		boolean headsUpOnly = intent.getBooleanExtra("headsUpOnly", false);

		Intent fullscreenIntent = new Intent(context, FullscreenAlarmActivity.class);
		fullscreenIntent.putExtra("title", title);
		fullscreenIntent.putExtra("body", body);
		fullscreenIntent.putExtra("requestCode", requestCode);
		fullscreenIntent.putExtra("classId", classId);
		fullscreenIntent.putExtra("occurrenceKey", occurrenceKey);
		if (subject != null && !subject.isEmpty()) {
			fullscreenIntent.putExtra("subject", subject);
		}
		if (room != null && !room.isEmpty()) {
			fullscreenIntent.putExtra("room", room);
		}
		if (startTime != null && !startTime.isEmpty()) {
			fullscreenIntent.putExtra("startTime", startTime);
		}
		if (endTime != null && !endTime.isEmpty()) {
			fullscreenIntent.putExtra("endTime", endTime);
		}
		fullscreenIntent.addFlags(
			Intent.FLAG_ACTIVITY_NEW_TASK
				| Intent.FLAG_ACTIVITY_CLEAR_TOP
				| Intent.FLAG_ACTIVITY_SINGLE_TOP
				| Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS
		);

		if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
			NotificationManager nm =
				(NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);

			String alarmsChannelId = "mysched_alarm_channel_v2";
			if (nm.getNotificationChannel(alarmsChannelId) == null) {
				NotificationChannel channel =
					new NotificationChannel(alarmsChannelId, "Alarms", NotificationManager.IMPORTANCE_HIGH);
				channel.setDescription("Alarm notifications");
				channel.setLockscreenVisibility(NotificationCompat.VISIBILITY_PUBLIC);
				channel.enableVibration(true);
				nm.createNotificationChannel(channel);
			}

			String headsUpChannelId = "mysched_heads_up_channel_v2";
			if (nm.getNotificationChannel(headsUpChannelId) == null) {
				NotificationChannel channel =
					new NotificationChannel(headsUpChannelId, "Upcoming Class Alerts", NotificationManager.IMPORTANCE_HIGH);
				channel.setDescription("Heads-up notifications before class alarms fire");
				channel.setLockscreenVisibility(NotificationCompat.VISIBILITY_PUBLIC);
				channel.enableVibration(true);
				nm.createNotificationChannel(channel);
			}

			PendingIntent fullScreenPendingIntent = PendingIntent.getActivity(
				context,
				requestCode,
				fullscreenIntent,
				PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
			);

			Intent dismissIntent = new Intent(context, AlarmDismissReceiver.class);
			dismissIntent.putExtra("notification_id", requestCode);
			dismissIntent.putExtra("classId", classId);
			dismissIntent.putExtra("occurrenceKey", occurrenceKey);
			PendingIntent dismissPi = PendingIntent.getBroadcast(
				context,
				requestCode + 1,
				dismissIntent,
				PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
			);

			String displayTitle =
				(subject != null && !subject.isEmpty())
					? subject
					: (title != null ? title : "Alarm");
			String displayBody = body != null ? body : "It's time!";

			Intent openIntent = new Intent(context, MainActivity.class);
			openIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TOP);
			PendingIntent contentIntent = PendingIntent.getActivity(
				context,
				requestCode + 2,
				openIntent,
				PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
			);

			String channelForBuilder = headsUpOnly ? headsUpChannelId : alarmsChannelId;

			NotificationCompat.Builder builder = new NotificationCompat.Builder(context, channelForBuilder)
				.setSmallIcon(android.R.drawable.ic_lock_idle_alarm)
				.setContentTitle(displayTitle)
				.setStyle(new NotificationCompat.BigTextStyle().bigText(displayBody))
				.setContentText(displayBody)
				.setPriority(NotificationCompat.PRIORITY_MAX)
				.setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
				.setShowWhen(true)
				.setWhen(System.currentTimeMillis())
				.setDefaults(NotificationCompat.DEFAULT_ALL)
				.setContentIntent(contentIntent)
				.setTicker(displayTitle);

			if (headsUpOnly) {
				builder
					.setCategory(NotificationCompat.CATEGORY_REMINDER)
					.setAutoCancel(true)
					.setOngoing(false);
				nm.notify(requestCode, builder.build());
				android.util.Log.d("AlarmReceiver", "Heads-up notification posted for request " + requestCode);
				return;
			} else {
				builder
					.setCategory(NotificationCompat.CATEGORY_ALARM)
					.setOngoing(true)
					.setFullScreenIntent(fullScreenPendingIntent, true)
					.setDeleteIntent(dismissPi)
					.addAction(android.R.drawable.ic_menu_close_clear_cancel, "Dismiss", dismissPi)
					.setAutoCancel(false);
				nm.notify(requestCode, builder.build());
				android.util.Log.d("AlarmReceiver", "Full-screen notification posted as backup");
			}
		}

		if (!headsUpOnly) {
			try {
				android.util.Log.d("AlarmReceiver", "Launching FullscreenAlarmActivity (Kotlin)");
				ContextCompat.startActivity(context, fullscreenIntent, null);
			} catch (Throwable t) {
				android.util.Log.e("AlarmReceiver", "Failed to launch FullscreenAlarmActivity", t);
			}
		}
	}

	private void showNotification(Context context, String title, String body, int requestCode) {
		NotificationManager notificationManager = (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);
		String channelId = "mysched_alarm_channel_v2";

		if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
			NotificationChannel channel = new NotificationChannel(channelId, "Alarms", NotificationManager.IMPORTANCE_HIGH);
			channel.setDescription("Full-screen alarm notifications");
			channel.enableVibration(true);
			channel.enableLights(true);
			channel.setShowBadge(true);
			notificationManager.createNotificationChannel(channel);
		}

		Intent dismissIntent = new Intent(context, AlarmDismissReceiver.class);
		dismissIntent.putExtra("notification_id", requestCode);
		PendingIntent dismissPi = PendingIntent.getBroadcast(
			context,
			requestCode,
			dismissIntent,
			PendingIntent.FLAG_UPDATE_CURRENT | (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M ? PendingIntent.FLAG_IMMUTABLE : 0)
		);

	NotificationCompat.Builder builder = new NotificationCompat.Builder(context, channelId)
		.setContentTitle(title != null ? title : "Alarm")
		.setStyle(new NotificationCompat.BigTextStyle().bigText(body != null ? body : "It's time!"))
		.setContentText(body != null ? body : "It's time!")
		.setSmallIcon(android.R.drawable.ic_lock_idle_alarm)
		.setPriority(NotificationCompat.PRIORITY_MAX)
		.setCategory(NotificationCompat.CATEGORY_ALARM)
		.setAutoCancel(true)
		.setOngoing(true)
		.setFullScreenIntent(null, true) // Don't use fullScreenIntent here since we handle it manually
		.addAction(android.R.drawable.ic_menu_close_clear_cancel, "Dismiss", dismissPi)
		.setDeleteIntent(dismissPi);

		notificationManager.notify(requestCode, builder.build());
	}
}
